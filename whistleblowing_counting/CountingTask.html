{{ block styles }}
<link href="{{ static 'whistleblowing_counting/grids.css' }}" rel="stylesheet"/>
{{ endblock }}

{{ block title }}
{{ if en }}
Task 1: Counting 1's
{{ elif vi }}
Nhiệm vụ 1: Đếm số 1
{{ endif }}
{{ endblock }}

{{ block content }}
<div class="text-end mb-3">
    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modal_content">
        {{ if en }}
        Instructions
        {{ elif vi }}
        Hướng dẫn
        {{ endif }}
    </button>
</div>

<div class="card bg-light mb-3">
    <div class="card-body">
        {{ if en }}
        <p>
            Select a grid by clicking on the corresponding button, count the number of 1's in
            the grid, enter the value in the input widget and click on "Validate". Then click on another grid.
        </p>

        {{ elif vi }}
        <p>
            Hãy chọn một bảng bằng cách nhấp vào nút tương ứng,
            đếm số lượng số 1 trong bảng, nhập giá trị vào ô nhập liệu và nhấp vào “Xác nhận”.
            Sau đó, chọn một bảng khác và lặp lại quy trình.
        </p>
        {{ endif }}
    </div>
</div>

<div class="text-center mb-3">
    {{ for grid in loop_grid_number }}
    <button type="button" id="id_g_{{forloop.counter}}" class="btn-secondary btn_grid_number my-1 mx-1"
            style="width: 35px"
            onclick="display_grid({{ forloop.counter }})">{{forloop.counter}}
    </button>
    {{ if forloop.counter == 20 or forloop.counter == 40 or forloop.counter == 60 or forloop.counter == 80 }}
    <br>
    {{ endif }}
    {{ endfor }}
</div>

<div class="text-center">
    <h6 class="text-info">
        {{ if en }}
        Grid
        {{ elif vi }}
        Bảng
        {{ endif }}
        <span id="grid_number">1</span></h6>
    <table class=" text-center mb-2 mx-auto">
        {{ for i in loop_rows }}
        <tr>
            {{ for j in loop_cols }}
            <td>
                <input type="number" name="grid_cell" id="r{{i}}_c{{j}}" class="my_cell" readonly>
            </td>
            {{ endfor }}
        </tr>
        {{ endfor }}
    </table>
    <div class="form-group form-inline text-center mb-3">
        <label for="grid_count">
            {{ if en }}
            Number of 1 in the grid:
            {{ elif vi }}
            Số lượng số 1 trong bảng:
            {{ endif }}
        </label>
        <input type="number" class="form-control-sm text-center" name="grid_count" id="grid_count"
               style="width: 80px">&nbsp;
        <button type="button" class="btn btn-primary" id="btn_validate" onclick="validate();">
            {{ if en }}
            Validate
            {{ elif vi }}
            Xác nhận
            {{ endif }}
        </button>
    </div>
</div>

<input type="hidden" name="counting_performance" id="id_counting_performance" value="0">
{{ include "global/InstructionsModal.html" }}

{{ endblock }}

{{ block scripts }}
<script>
    const grids = js_vars.grids;
    let current_grid;
    let grid_count = document.querySelector("#grid_count");
    let input_score = document.querySelector("#id_counting_performance");

    function display_grid(grid_number) {
        current_grid = grids[grid_number - 1];
        document.querySelector("#grid_number").innerHTML = String(grid_number);
        let grid_cells = document.querySelectorAll("input[type=number][name=grid_cell]");
        let counter = 0;
        for (let r of current_grid.grid) {
            for (let c of r) {
                grid_cells[counter].value = c;
                counter++;
            }
        }
        grid_count.value = "";
    }

    function validate() {
        let answer = Number(grid_count.value);
        if (answer === current_grid["total"])
            input_score.value = Number(input_score.value) + 1
        let the_btn = document.querySelector(`#id_g_${current_grid['number']}`);
        the_btn.classList.remove("bg-secondary");
        the_btn.classList.add("bg-warning");
        the_btn.disabled = true;
        the_btn.setAttribute("title", String(answer));
        grid_count.value = null;
        current_grid = null;
    }

    function fill_auto() {
        const btn_grid_number = document.querySelectorAll(".btn_grid_number");
        let randomIndex = Math.floor(Math.random() * btn_grid_number.length);
        let selectedBtn = btn_grid_number[randomIndex];
        if (!selectedBtn.disabled) {
            selectedBtn.click();
            if (current_grid) {
                grid_count.value = Math.random() <= 0.5 ? current_grid["total"] : Math.floor(Math.random() * 101);
                document.querySelector("#btn_validate").click();
            }
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        display_grid(1);
        const otree_timer = document.querySelector(".otree-timer");
        otree_timer.classList.remove("alert", "alert-warning");
        otree_timer.style.color = "DarkGoldenrod";
        if (js_vars.fill_auto) {
            setInterval(() => {
                fill_auto();
            }, Math.floor(Math.random() * 10000));
        }
    });

</script>
{{ endblock }}
